define(["exports","core/ajax","./common","core/templates","core/notification","core/modal_factory","core/modal_events","core/log","core/str"],(function(_exports,Ajax,_common,Templates,Notification,ModalFactory,ModalEvents,_log,_str){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Ajax=_interopRequireWildcard(Ajax),Templates=_interopRequireWildcard(Templates),Notification=_interopRequireWildcard(Notification),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),_log=(obj=_log)&&obj.__esModule?obj:{default:obj};return _exports.default=class{constructor(recorder){_defineProperty(this,"itemdata",[]),_defineProperty(this,"component","tiny_poodll"),_defineProperty(this,"strings",{});var that=this,config=recorder.config;this.recorder=recorder,this.loadHistory().then((function(historyitems){Array.isArray(historyitems.responses)&&historyitems.responses.forEach((function(item){var dateToFormat,dateObj;item.hasOwnProperty("dateofentry")&&(item.displaydateofentry=(dateToFormat=item.dateofentry,(dateObj=new Date(1e3*dateToFormat)).getUTCMonth()+1+"/"+dateObj.getUTCDate()+"/"+dateObj.getUTCFullYear()),item.displayfiletitle=item.filetitle.substring(0,config.filetitledisplaylength)+"...",item.editablefield=[JSON.parse(item.editabletitle)],that.itemdata[item.id]=item)}));var context={data:historyitems.responses};return Templates.render("tiny_poodll/historypanel",context)})).then((function(html,js){Templates.replaceNodeContents('div[data-field="history"]',html,js),that.initDataTables(),that.registerEvents()})),this.initStrings()}initStrings(){var that=this;(0,_str.get_strings)([{key:"previewitem",component:this.component},{key:"deleteitem",component:this.component},{key:"confirmdelete",component:this.component},{key:"loading",component:this.component},{key:"insertitem",component:this.component}]).done((function(s){var i=0;that.strings.previewitem=s[i++],that.strings.deleteitem=s[i++],that.strings.confirmdelete=s[i++],that.strings.loading=s[i++],that.strings.insertitem=s[i++]}))}initDataTables(){var that=this;require(["jquery","https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"],(function($,datatable){that.table=$("#tiny_poodll_history_table").DataTable(),_log.default.debug("datatable loaded"),_log.default.debug(that.table)}))}registerEvents(){const that=this;_log.default.debug("events registering"),document.getElementById("tiny_poodll_history_table").addEventListener("click",(function(event){const target=event.target;if("delete"===target.dataset.actionType){_log.default.debug("delete clicked");const clickedLink=target;ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:that.strings.deleteitem,body:that.strings.confirmdelete},clickedLink).then((function(modal){modal.setSaveButtonText(that.strings.deleteitem);const root=modal.getRoot();root.on(ModalEvents.cancel,(function(){modal.hide()})),root.on(ModalEvents.save,(function(){const historyRow=clickedLink.closest("tr").previousElementSibling,historyItemId=historyRow.dataset.historyId,childHistoryRow=clickedLink.closest("tr");Ajax.call([{methodname:"tiny_poodll_history_archive",args:{id:historyItemId},done:function(){childHistoryRow.style.display="none",historyRow.style.display="none"}}]),modal.hide()})),modal.show()}))}})),document.getElementById("tiny_poodll_history_table").addEventListener("click",(function(event){const target=event.target;if("add"===target.dataset.actionType){_log.default.debug("insert clicked");const historyItem=that.fetchHistoryItem(target.dataset.historyId);that.recorder.doInsert(historyItem.mediaurl,historyItem.mediafilename,historyItem.sourceurl,historyItem.sourcemimetype)}})),document.getElementById("tiny_poodll_history_table").addEventListener("click",(function(event){const target=event.target;if("preview"===target.dataset.actionType){_log.default.debug("preview clicked");const clickedLink=target;that.loadHistoryPreview(target.dataset.historyId,clickedLink)}})),document.querySelector("#tiny_poodll_history_table tbody").addEventListener("click",(function(event){const target=event.target;if(target.classList.contains("details-control")){_log.default.debug("details control clicked");const tr=target.closest("tr"),row=that.table.row(tr);if(row.child.isShown())row.child.hide(),tr.classList.remove("shown");else{const rowdata={name:"id",value:tr.dataset.historyId};Templates.render("tiny_poodll/historyrow",rowdata).then((function(html,js){row.child(html).show(),_log.default.debug("added "+html),tr.classList.add("shown")}))}}}))}loadHistory(){var config=this.recorder.config;return Ajax.call([{methodname:"tiny_poodll_history_get_items",args:{recordertype:config.recorder},async:!1}])[0]}saveHistoryItem(mediaurl,mediafilename,sourceurl,sourcemimetype){_log.default.debug("ajax saving history item");return Ajax.call([{methodname:"tiny_poodll_history_create",args:{recordertype:this.recorder.config.recorder,mediafilename:mediafilename,sourceurl:sourceurl,mediaurl:mediaurl,sourcemimetype:sourcemimetype,subtitling:this.recorder.config.subtitling?1:0,subtitleurl:this.recorder.config.subtitling?mediaurl+".vtt":""}}])[0]}loadHistoryPreview(historyid,clickedLink){var that=this,historyItem=this.fetchHistoryItem(historyid),context={data:historyItem,isVideo:"video"===that.recorder.config.recorder||"screen"===that.recorder.config.recorder};Templates.render("tiny_poodll/historypreview",context).then((function(html,js){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:that.strings.previewitem,body:html},clickedLink).then((function(modal){modal.setSaveButtonText(that.strings.insertitem);var root=modal.getRoot();root.on(ModalEvents.cancel,(function(){modal.hide()})),root.on(ModalEvents.save,(function(){that.recorder.doInsert(historyItem.mediaurl,historyItem.mediafilename,historyItem.sourceurl,historyItem.sourcemimetype),modal.hide()})),modal.show()}))})).fail((function(ex){Notification.exception(ex)}))}insertHistoryItem(historyid){var context={data:this.fetchHistoryItem(historyid).responses,isVideo:"video"===this.recorder.config.recorder||"screen"===this.recorder.config.recorder};Templates.render("tiny_poodll/historypreview",context).then((function(html,js){Templates.replaceNodeContents('div[data-field="history"]',html,js)})).fail((function(ex){Notification.exception(ex)}))}fetchHistoryItem(historyid){return this.itemdata[historyid]}},_exports.default}));

//# sourceMappingURL=history.min.js.map