define(["exports","core/ajax","./common","core/templates","core/notification","core/modal_save_cancel","core/modal_factory","core/modal_events","core/log","core/str"],(function(_exports,Ajax,_common,Templates,Notification,_modal_save_cancel,ModalFactory,ModalEvents,_log,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Ajax=_interopRequireWildcard(Ajax),Templates=_interopRequireWildcard(Templates),Notification=_interopRequireWildcard(Notification),_modal_save_cancel=_interopRequireDefault(_modal_save_cancel),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),_log=_interopRequireDefault(_log);return _exports.default=class{constructor(recorder){_defineProperty(this,"itemdata",[]),_defineProperty(this,"component","tiny_poodll"),_defineProperty(this,"strings",{});var that=this,config=recorder.config;this.recorder=recorder,this.loadHistory().then((function(historyitems){Array.isArray(historyitems.responses)&&historyitems.responses.forEach((function(item){var dateToFormat,dateObj;item.hasOwnProperty("dateofentry")&&(item.displaydateofentry=(dateToFormat=item.dateofentry,(dateObj=new Date(1e3*dateToFormat)).getUTCMonth()+1+"/"+dateObj.getUTCDate()+"/"+dateObj.getUTCFullYear()),item.displayfiletitle=item.filetitle.substring(0,config.filetitledisplaylength)+"...",item.editablefield=[JSON.parse(item.editabletitle)],that.itemdata[item.id]=item)}));var context={data:historyitems.responses};return Templates.render("tiny_poodll/historypanel",context)})).then((function(html,js){Templates.replaceNodeContents('div[data-field="history"]',html,js),that.initDataTables(),that.registerEvents()})),this.initStrings()}initStrings(){var that=this;(0,_str.get_strings)([{key:"previewitem",component:this.component},{key:"deleteitem",component:this.component},{key:"confirmdelete",component:this.component},{key:"loading",component:this.component},{key:"insertitem",component:this.component}]).done((function(s){var i=0;that.strings.previewitem=s[i++],that.strings.deleteitem=s[i++],that.strings.confirmdelete=s[i++],that.strings.loading=s[i++],that.strings.insertitem=s[i++]}))}initDataTables(){var that=this;require(["jquery","https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"],(function($,datatable){that.table=$("#"+that.recorder.elementid+"_tiny_poodll_history .tiny_poodll_history_table").DataTable()}))}registerEvents(){var that=this;_log.default.debug("history events registering against #"+that.recorder.elementid+"_tiny_poodll_history"),document.querySelector("#"+that.recorder.elementid+"_tiny_poodll_history .tiny_poodll_history_table").addEventListener("click",(function(event){const target=event.target;switch(target.dataset.actiontype){case"delete":event.preventDefault(),_log.default.debug("delete clicked"),that.loadHistoryDelete(target.dataset.historyid,target);break;case"add":event.preventDefault(),_log.default.debug("insert clicked");const historyItem=that.fetchHistoryItem(target.dataset.historyid);that.recorder.doInsert(historyItem.mediaurl,historyItem.mediafilename,historyItem.sourceurl,historyItem.sourcemimetype);break;case"preview":event.preventDefault(),_log.default.debug("preview clicked"),that.loadHistoryPreview(target.dataset.historyid,target);break;case"togglerow":event.preventDefault(),_log.default.debug("details control clicked");const tr=target.closest("tr"),row=that.table.row(tr);if(row.child.isShown())row.child.hide(),tr.classList.remove("shown");else{const rowdata={name:"id",value:tr.dataset.historyid};Templates.render("tiny_poodll/historyrow",rowdata).then((function(html,js){row.child(html).show(),tr.classList.add("shown")}))}break;default:"I"===target.tagName&&target.parentElement.hasAttribute("data-actiontype")&&(event.preventDefault(),target.parentElement.click())}}))}loadHistory(){var config=this.recorder.config;return Ajax.call([{methodname:"tiny_poodll_history_get_items",args:{recordertype:config.recorder},async:!1}])[0]}saveHistoryItem(mediaurl,mediafilename,sourceurl,sourcemimetype){_log.default.debug("ajax saving history item");return Ajax.call([{methodname:"tiny_poodll_history_create",args:{recordertype:this.recorder.config.recorder,mediafilename:mediafilename,sourceurl:sourceurl,mediaurl:mediaurl,sourcemimetype:sourcemimetype,subtitling:this.recorder.config.subtitling?1:0,subtitleurl:this.recorder.config.subtitling?mediaurl+".vtt":""}}])[0]}loadHistoryDelete(historyid,clickedLink){var that=this;_modal_save_cancel.default.create({title:that.strings.deleteitem,body:that.strings.confirmdelete,show:!0,buttons:{save:that.strings.deleteitem},removeOnClose:!0}).then((function(modal){const root=modal.getRoot();root.on(ModalEvents.cancel,(function(){modal.hide()})),root.on(ModalEvents.save,(function(){const historyItemId=clickedLink.dataset.historyid,therow=document.querySelector('tr[data-historyid="'+historyItemId+'"]');var dtparentrow=that.table.row(therow);dtparentrow.node()||(_log.default.debug("Row is not part of the DataTables instance."),(dtparentrow=that.table.row('tr[data-historyid="'+historyItemId+'"]')).node())?Ajax.call([{methodname:"tiny_poodll_history_archive",args:{id:historyItemId},done:function(){dtparentrow.remove().draw()}}]):_log.default.debug("Row is still not part of the DataTables instance.")}))}))}loadHistoryPreview(historyid,clickedLink){var that=this,historyItem=this.fetchHistoryItem(historyid),context={data:historyItem,isVideo:"video"===that.recorder.config.recorder||"screen"===that.recorder.config.recorder};Templates.render("tiny_poodll/historypreview",context).then((function(html,js){_modal_save_cancel.default.create({title:that.strings.previewitem,body:html,show:!0,buttons:{save:that.strings.insertitem},removeOnClose:!0}).then((function(modal){const root=modal.getRoot();root.on(ModalEvents.cancel,(function(){modal.hide()})),root.on(ModalEvents.save,(function(){that.recorder.doInsert(historyItem.mediaurl,historyItem.mediafilename,historyItem.sourceurl,historyItem.sourcemimetype)}))}))})).fail((function(ex){Notification.exception(ex)}))}fetchHistoryItem(historyid){return this.itemdata[historyid]}},_exports.default}));

//# sourceMappingURL=history.min.js.map