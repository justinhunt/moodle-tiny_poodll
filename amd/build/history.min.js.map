{"version":3,"file":"history.min.js","sources":["../src/history.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Poodll - audio recorder configuration.\n *\n * @module      tiny_poodll/audio_recorder\n * @copyright   2023 Justin Hunt <justin@poodll.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\nimport * as Ajax from 'core/ajax';\nimport {component, INSERTMETHOD, SKIN} from \"./common\";\nimport * as Templates from 'core/templates';\nimport * as Notification from 'core/notification';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport Modal from \"./modal\";\nimport ModalRegistry from 'core/modal_registry';\nimport Log from 'core/log';\n\nexport default class {\n\n    itemdata= [];\n\n    /**\n     * Constructor for the Tiny Poodll Recorder History Tab\n     *\n     * @param {recorder} recorder The recorder this history is associated with\n     */\n    constructor(recorder) {\n        var that =this;\n        var config = recorder.config;\n        var processHistoryItems = function (historyitems) {\n            /**\n             * Takes a mysql unix timestamp (in seconds) and converts to a display date.\n             *\n             * @method _formatUnixDate\n             * @param dateToFormat Date to format\n             */\n            function _formatUnixDate(dateToFormat) {\n                var dateObj = new Date(dateToFormat * 1000);\n\n                var month = dateObj.getUTCMonth() + 1;\n                var day = dateObj.getUTCDate();\n                var year = dateObj.getUTCFullYear();\n\n                return month + \"/\" + day + \"/\" + year;\n            }\n\n            if (Array.isArray(historyitems.responses)) {\n                historyitems.responses.forEach(function(item){\n                    if(item.hasOwnProperty('dateofentry')) {\n                        item.displaydateofentry = _formatUnixDate(item.dateofentry);\n                        item.displayfiletitle = item.filetitle.substring(0, config.filetitledisplaylength) + '...';\n                        that.itemdata[item.id] = item;\n                    }\n                });\n            }\n\n            var context = {data: historyitems.responses};\n            return Templates.render('tiny_poodll/historypanel', context);\n\n        };\n\n        this.recorder = recorder;\n        this.loadHistory()\n            .then(processHistoryItems)\n            .then(function (html, js) {\n                Templates.replaceNodeContents('div[data-field=\"history\"]', html, js);\n                that.initDataTables();\n                that.registerEvents();\n        });\n\n    }\n\n    initDataTables() {\n        var that=this;\n        require(\n            ['jquery','https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js',], function($, datatable) {\n\n                that.table = $('#tiny_poodll_history_table').DataTable();\n\n                Log.debug('datatable loaded');\n                Log.debug(that.table);\n\n            });\n    }\n\n   registerEvents() {\n       var that = this;\n       Log.debug('events registering');\n\n       //handle the removal of an item from the history table\n       $('#tiny_poodll_history_table').on('click', 'a[data-action-type=\"delete\"]', function() {\n           Log.debug('delete clicked');\n           var clickedLink = $(this);\n           ModalFactory.create({\n               type: ModalFactory.types.SAVE_CANCEL,\n               title: '{{# str }} deleteitem, tiny_poodll {{/ str }}',\n               body: '{{# str }} confirmdelete, tiny_poodll {{/ str }}',\n           }, clickedLink    )\n               .then(function(modal) {\n                   modal.setSaveButtonText('Delete');\n                   var root = modal.getRoot();\n                   root.on(ModalEvents.cancel, function() {modal.hide();});\n                   root.on(ModalEvents.save, function() {\n                       let historyRow = clickedLink.parents('table').parents('tr').first().prev('.history-row');\n                       let historyItemId = historyRow.data('history-id');\n                       let childHistoryRow = clickedLink.parents('table').parents('tr').first();\n\n                       Ajax.call([{\n                           methodname: 'tiny_poodll_history_archive',\n                           args: {'id': historyItemId},\n                           done: function () {\n                               childHistoryRow.fadeOut(300, function(){ $(this).remove();});\n                               historyRow.fadeOut(300, function(){ $(this).remove();});\n                           }\n                       }]);\n                       modal.hide()\n                   });\n                   modal.show();\n               });\n       });\n\n       // Handle the insert of an item from history\n       $('#tiny_poodll_history_table').on('click', 'a[data-action-type=\"add\"]', function() {\n           Log.debug('insert clicked');\n           var historyitem = that.fetchHistoryItem($(this).data('history-id'));\n           that.recorder.doInsert(historyitem.mediaurl, historyitem.mediafilename,\n               historyitem.sourceurl, historyitem.sourcemimetype);\n       });\n\n       // Handle the preview of an item in the history table\n       $('#tiny_poodll_history_table').on('click', 'a[data-action-type=\"preview\"]', function() {\n           Log.debug('preview clicked');\n           const loadingHtml = '<br /><div class=\"d-flex justify-content-center\">\\n' +\n               '  <div class=\\\"spinner-border\\\" role=\"status\">\\n' +\n               '    <span class=\\\"sr-only\\\">{{# str }} loading, tiny_poodll {{/ str }}</span>\\n' +\n               '  </div>\\n' +\n               '</div><br />';\n\n         //  $('div[data-field=\"history\"]').html(loadingHtml);\n           var clickedLink = $(this);\n           that.loadHistoryPreview($(this).data('history-id'),clickedLink);\n       });\n\n\n       //toggle display of row in the history table\n       //for some reason fails to fire when parent is table even though table is in DOM\n       $('#tiny_poodll_history_table tbody').on('click', 'td.details-control', function () {\n           Log.debug('details control clicked');\n           var tr = $(this).closest('tr');\n           Log.debug(tr);\n           var row = that.table.row(tr);\n           Log.debug(row);\n           if ( row.child.isShown() ) {\n               row.child.hide();\n               tr.removeClass('shown');\n           }\n           else {\n               var rowdata = {\"name\": \"id\", \"value\": tr.data('history-id') };\n               Templates.render('tiny_poodll/historyrow',rowdata).then(\n                   function(html,js){\n                       row.child($(html)).show();\n                       Log.debug('added ' + html);\n                       tr.addClass('shown');\n                   }\n               );\n           }\n       });\n\n\n\n   }\n\n    loadHistory() {\n        var that = this;\n        var config = that.recorder.config;\n        return Ajax.call([{\n            methodname: 'tiny_poodll_history_get_items',\n            args: {'recordertype': config.recorder},\n            async: false, //this means the function is blocking\n        }])[0];\n    }\n\n    /**\n     * Creates the media html5 tags based on the recorder type.\n     *\n     * @method saveHistoryItem\n     * @param  historyItem\n     */\n    saveHistoryItem(mediaurl, mediafilename, sourceurl, sourcemimetype) {\n        Log.debug(\"ajax saving history item\");\n        var that=this;\n        return Ajax.call([{\n            methodname: 'tiny_poodll_history_create',\n            args: {\n                recordertype: that.recorder.config.recorder,\n                mediafilename: mediafilename,\n                sourceurl: sourceurl,\n                mediaurl: mediaurl,\n                sourcemimetype: sourcemimetype,\n                subtitling: that.recorder.config.subtitling ? 1 : 0,\n                subtitleurl: that.recorder.config.subtitling ? mediaurl + '.vtt' : '',\n            },\n        }])[0];\n    }\n\n    /**\n     * Creates the media html5 tags based on the recorder type.\n     *\n     * @method loadHistoryPreview\n     * @param  historyItem\n     */\n    loadHistoryPreview(historyid, clickedLink){\n        var that=this;\n\n        var historyItem = this.fetchHistoryItem(historyid);\n        var context = {\n            data: historyItem,\n            isVideo: that.recorder.config.recorder === 'video' || that.recorder.config.recorder === 'screen'\n        };\n        Templates.render('tiny_poodll/historypreview', context)\n            .then(function (html, js) {\n\n\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: '{{# str }} deleteitem, tiny_poodll {{/ str }}',\n                    body: html,\n                }, clickedLink )\n                    .then(function(modal) {\n                        modal.setSaveButtonText('Insert');\n                        var root = modal.getRoot();\n                        root.on(ModalEvents.cancel, function() {modal.hide();});\n                        root.on(ModalEvents.save, function() {\n                                that.recorder.doInsert(historyItem.mediaurl, historyItem.mediafilename,\n                                historyItem.sourceurl, historyItem.sourcemimetype);\n                                modal.hide();\n                        });\n                        modal.show();\n                    });\n\n\n\n            }).fail(function (ex) {\n            Notification.exception(ex);\n        });\n\n\n\n    }\n\n    /**\n     * Inserts the histopry item\n     *\n     * @method insertHistoryItem\n     * @param  historyid\n     */\n   insertHistoryItem(historyid) {\n        var that=this;\n        var historyItemData = this.fetchHistoryItem(historyid);\n        var context = {\n            data: historyItemData.responses,\n            isVideo: that.recorder.config.recorder === 'video' || that.recorder.config.recorder === 'screen'\n        };\n        Templates.render('tiny_poodll/historypreview', context)\n            .then(function (html, js) {\n                Templates.replaceNodeContents('div[data-field=\"history\"]', html, js);\n            }).fail(function (ex) {\n            Notification.exception(ex);\n        });\n\n    }\n\n   fetchHistoryItem(historyid) {\n       return this.itemdata[historyid];\n       /*\n        return Ajax.call([{\n            methodname: 'tiny_poodll_history_get_item',\n            args: {'id': historyid}\n        }])[0];\n        */\n\n    }\n}\n"],"names":["constructor","recorder","that","this","config","loadHistory","then","historyitems","Array","isArray","responses","forEach","item","dateToFormat","dateObj","hasOwnProperty","displaydateofentry","dateofentry","Date","getUTCMonth","getUTCDate","getUTCFullYear","displayfiletitle","filetitle","substring","filetitledisplaylength","itemdata","id","context","data","Templates","render","html","js","replaceNodeContents","initDataTables","registerEvents","require","$","datatable","table","DataTable","debug","on","clickedLink","ModalFactory","create","type","types","SAVE_CANCEL","title","body","modal","setSaveButtonText","root","getRoot","ModalEvents","cancel","hide","save","historyRow","parents","first","prev","historyItemId","childHistoryRow","Ajax","call","methodname","args","done","fadeOut","remove","show","historyitem","fetchHistoryItem","doInsert","mediaurl","mediafilename","sourceurl","sourcemimetype","loadHistoryPreview","tr","closest","row","child","isShown","removeClass","rowdata","addClass","async","saveHistoryItem","recordertype","subtitling","subtitleurl","historyid","historyItem","isVideo","fail","ex","Notification","exception","insertHistoryItem"],"mappings":"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"}