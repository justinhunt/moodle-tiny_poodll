define("tiny_poodll/rec_audio",["exports","core/str","core/pending","core/log","./options","editor_tiny/uploader","core/toast","core/modal_events","core/modal_factory","core/templates","core/notification","core/prefetch","./modal","core/modal_registry","./common"],(function(_exports,_str,_pending,_log,_options,_uploader,_toast,ModalEvents,ModalFactory,Templates,_notification,_prefetch,_modal,_modal_registry,_common){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_pending=_interopRequireDefault(_pending),_log=_interopRequireDefault(_log),_uploader=_interopRequireDefault(_uploader),ModalEvents=_interopRequireWildcard(ModalEvents),ModalFactory=_interopRequireWildcard(ModalFactory),Templates=_interopRequireWildcard(Templates),_modal=_interopRequireDefault(_modal),_modal_registry=_interopRequireDefault(_modal_registry);return _exports.default=class{constructor(editor,elementid,modal,config){this.ready=!1,this.editor=editor,this.elementid=elementid,this.config=config,this.modal=modal,this.modalRoot=modal.getRoot()[0],this.registerEventListeners(),this.ready=!0}close(){this.modal.hide()}registerEventListeners(){var that=this;const root=this.modal.getRoot()[0];var controls={};const recorders=root.querySelectorAll("."+_common.CSS.CP_SWAP);root.addEventListener("click",(e=>{switch(_log.default.debug(e.target.id),e.target.id){case that.elementid+"_"+_common.CSS.SUBTITLE_CHECKBOX:cbox.get("checked")?(recorders.forEach((recorder=>{recorder.setAttribute("data-transcribe","1"),recorder.setAttribute("data-subtitle","1"),recorder.setAttribute("data-alreadyparsed","false"),recorder.innerHTML=""})),controls.subtitling=!0):(recorders.forEach((recorder=>{recorder.setAttribute("data-transcribe","0"),recorder.setAttribute("data-subtitle","0"),recorder.setAttribute("data-alreadyparsed","false"),recorder.innerHTML=""})),controls.subtitling=!1),that.loadRecorders();break;case that.elementid+"_"+_common.CSS.MEDIAINSERT_CHECKBOX:cbox.get("checked")?controls.insertmethod=_common.INSERTMETHOD.TAGS:controls.insertmethod=_common.INSERTMETHOD.LINK}})),root.addEventListener("change",(e=>{const dropdown=e.target;if(dropdown)switch(dropdown.id){case that.elementid+"_"+_common.CSS.LANG_SELECT:CLOUDPOODLL.language=dropdown.get("value"),recorders.forEach((recorder=>{recorder.setAttribute("data-language",CLOUDPOODLL.language),recorder.setAttribute("data-alreadyparsed","false"),recorder.innerHTML=""})),that.loadRecorders();break;case that.elementid+"_"+_common.CSS.EXPIREDAYS_SELECT:recorders.forEach((recorder=>{recorder.setAttribute("data-expiredays",CLOUDPOODLL.expiredays),recorder.setAttribute("data-alreadyparsed","false"),recorder.innerHTML=""})),that.loadRecorders()}}))}displayWidgetsDialogue(e,clickedicon){e.preventDefault();var dialogue=this.getDialogue({headerContent:M.util.get_string("dialogtitle",COMPONENTNAME),width:"800px",focusAfterHide:clickedicon});"800px"!==dialogue.width&&dialogue.set("width","800px");var bodycontent=Y.Node.create("<div></div>"),template=Y.Handlebars.compile(BUTTONSHEADERTEMPLATE),content=Y.Node.create(template({headertext:M.util.get_string("chooseinsert",COMPONENTNAME)}));bodycontent.append(content);var buttons=this._getButtonsForNames(clickedicon);Y.Array.each(buttons,(function(button){bodycontent.append(button)}),bodycontent),dialogue.set("bodyContent",bodycontent),dialogue.show(),this.markUpdated()}getButtonsForNames(clickedicon){var allcontent=[];return Y.Array.each(CLOUDPOODLL.names,(function(thename,currentindex){var template=Y.Handlebars.compile(BUTTONTEMPLATE),content=Y.Node.create(template({elementid:this.get("host").get("elementid"),name:thename,templateindex:currentindex}));this._form=content,content.one("."+_common.CSS.NAMEBUTTON+"_"+currentindex).on("click",this._showTemplateForm,this,currentindex),allcontent.push(content)}),this),allcontent}getSubmitButtons(templateindex){var template=Y.Handlebars.compile(SUBMITTEMPLATE),content=Y.Node.create(template({elementid:this.get("host").get("elementid"),inserttext:M.util.get_string("insert",COMPONENTNAME)}));return content.one("."+_common.CSS.INPUTSUBMIT).on("click",this._doWidgetsInsert,this,templateindex),content}displayDialogue(e,recorder){if(e.preventDefault(),this._currentrecorder=recorder,recorder!=RECORDERS.WIDGETS){switch(STATE.currentrecorder=recorder,recorder){case RECORDERS.SCREEN:var title=M.util.get_string("createscreen",COMPONENTNAME),width="502",height="660";break;case RECORDERS.VIDEO:title=M.util.get_string("createvideo",COMPONENTNAME);switch(CLOUDPOODLL.videoskin){case _common.SKIN.ONETWOTHREE:width="500",height="660";break;case _common.SKIN.PLAIN:width="500",height="580";break;case _common.SKIN.BMR:width="500",height="620";break;default:width="500",height=!1}break;case RECORDERS.AUDIO:default:title=M.util.get_string("createaudio",COMPONENTNAME),width="501",height=!1}CLOUDPOODLL.cansubtitle?STATE.currentrecorder==RECORDERS.VIDEO||STATE.currentrecorder==RECORDERS.SCREEN?STATE.subtitling=STATE.subtitlevideobydefault:STATE.subtitling=STATE.subtitleaudiobydefault:STATE.subtitling=0;var d_conf={center:!0};d_conf.headerContent=title,d_conf.focusAfterHide=recorder,d_conf.width=width+"px",height&&(d_conf.height=height+"px");var dialogue=this.getDialogue(d_conf);dialogue.get("width")!=width+"px"&&(dialogue.set("headerContent",title),dialogue.set("width",width+"px"),dialogue.set("height",height+"px"));var output="";if(""==CLOUDPOODLL.token)output=M.util.get_string("notoken",COMPONENTNAME);else{var context=this._getContext(),that=this;require(["core/templates","core/ajax","core/notification"],(function(templates,ajax,notification){templates.render("atto_cloudpoodll/root",context).then((function(html,js){output=html;var content=Y.Node.create(output);dialogue.set("bodyContent",content).show(),STATE.elementid=that.get("host").get("elementid"),STATE.subtitlecheckbox=Y.one("#"+STATE.elementid+"_"+_common.CSS.SUBTITLE_CHECKBOX),STATE.mediainsertcheckbox=Y.one("#"+STATE.elementid+"_"+_common.CSS.MEDIAINSERT_CHECKBOX),STATE.languageselect=Y.one("#"+STATE.elementid+"_"+_common.CSS.LANG_SELECT),STATE.expiredays=Y.one("#"+STATE.elementid+"_"+_common.CSS.EXPIREDAYS_SELECT);var topnode=Y.one("#"+STATE.elementid+"_"+_common.CSS.ATTO_CLOUDPOODLL_FORM);poodllRecorder=that,null!=STATE.subtitlecheckbox&&(CLOUDPOODLL.cansubtitle?STATE.subtitlecheckbox.on("click",(function(e){e.currentTarget.get("checked")?(topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-transcribe","1"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-subtitle","1"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-alreadyparsed","false"),STATE.subtitling=!0):(topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-transcribe","0"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-subtitle","0"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-alreadyparsed","false"),STATE.subtitling=!1),topnode.all("."+_common.CSS.CP_SWAP).empty(),that._loadRecorders()})):this._disableSubtitleCheckbox()),null!=STATE.mediainsertcheckbox&&STATE.mediainsertcheckbox.on("click",(function(e){e.currentTarget.get("checked")?STATE.insertmethod=_common.INSERTMETHOD.TAGS:STATE.insertmethod=_common.INSERTMETHOD.LINK})),null!=STATE.languageselect&&STATE.languageselect.on("change",(function(e){var element=e.currentTarget;element&&(CLOUDPOODLL.language=element.get("value"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-language",CLOUDPOODLL.language),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-alreadyparsed","false"),topnode.all("."+_common.CSS.CP_SWAP).empty(),that._loadRecorders())})),null!=STATE.expiredays&&STATE.expiredays.on("change",(function(e){var element=e.currentTarget;element&&(CLOUDPOODLL.expiredays=element.get("value"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-expiredays",CLOUDPOODLL.expiredays),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-alreadyparsed","false"),topnode.all("."+_common.CSS.CP_SWAP).empty(),that._loadRecorders())})),that._loadRecorders()})).fail((function(ex){notification.exception(ex)}))}))}}else this._displayWidgetsDialogue(e,recorder)}disableSubtitleCheckbox(){STATE.subtitlecheckbox.setAttribute("disabled",!0);var topnode=Y.one("#"+STATE.elementid+"_"+_common.CSS.ATTO_CLOUDPOODLL_FORM);topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-transcribe","0"),topnode.all("."+_common.CSS.CP_SWAP).setAttribute("data-subtitle","0")}loadHistory(){require(["core/templates","core/ajax","core/notification"],(function(templates,ajax,notification){ajax.call([{methodname:"atto_cloudpoodll_history_get_items",args:{recordertype:STATE.currentrecorder},done:function(historyitems){Array.isArray(historyitems.responses)&&(historyitems.responses.forEach((function(item){var dateToFormat,dateObj;item.displaydateofentry=(dateToFormat=item.dateofentry,(dateObj=new Date(1e3*dateToFormat)).getUTCMonth()+1+"/"+dateObj.getUTCDate()+"/"+dateObj.getUTCFullYear()),item.displayfiletitle=item.filetitle.substring(0,STATE.filetitledisplaylength)+"..."})),historyitems.responses.formatted=JSON.stringify(historyitems.responses));var context={data:historyitems.responses};templates.render("atto_cloudpoodll/historypanel",context).then((function(html,js){templates.replaceNodeContents('div[data-field="history"]',html,js)})).fail((function(ex){notification.exception(ex)}))}}])}))}loadHistoryPreview(historyItem){require(["core/templates","core/ajax","core/notification"],(function(templates,ajax,notification){ajax.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:historyItem.dataset.historyId},done:function(historyItemData){var context={data:historyItemData.responses,isVideo:STATE.currentrecorder===RECORDERS.VIDEO||STATE.currentrecorder===RECORDERS.SCREEN};templates.render("atto_cloudpoodll/historypreview",context).then((function(html,js){templates.replaceNodeContents('div[data-field="history"]',html,js)})).fail((function(ex){notification.exception(ex)}))}}])}))}loadRecorders(){var that=this;_log.default.debug("loading recorders"),that.uploaded=!1,that.ap_count=0,require(["tiny_poodll/cloudpoodllloader"],(function(loader){loader.init(_common.CSS.CP_SWAP,(function(evt){switch(evt.type){case"recording":"started"===evt.action&&null!=STATE.subtitlecheckbox&&STATE.subtitlecheckbox.set("disabled",!0);break;case"awaitingprocessing":that.uploaded||(setTimeout((function(){var guessed_ext=loader.fetch_guessed_extension(STATE.currentrecorder),sourcefilename=evt.sourcefilename.split(".").slice(0,-1).join(".")+"."+guessed_ext,sourceurl=evt.s3root+sourcefilename;that._doInsert(evt.mediaurl,evt.mediafilename,sourceurl,evt.sourcemimetype)}),4e3),that.uploaded=!0);break;case"filesubmitted":break;case"error":alert("PROBLEM:"+evt.message)}}))}))}insertHistoryItem(historyItem){poodllRecorder.getDialogue({focusAfterHide:null}).hide(),require(["core/ajax"],(function(ajax){ajax.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:historyItem.dataset.historyId},done:function(historyItemData){var item=historyItemData.responses[0],mediaLink=poodllRecorder._createMediaLink(item.mediaurl,item.mediafilename,item.sourceurl,item.sourcemimetype);switch(STATE.insertmethod){case _common.INSERTMETHOD.TAGS:mediaLink.template=poodllRecorder._createMediaTemplate(mediaLink.context,item.sourcemimetype,mediaLink.template);case _common.INSERTMETHOD.LINK:}poodllRecorder._insertIntoEditor(mediaLink.template,mediaLink.context)}}])}))}createMediaLink(mediaurl,mediafilename,sourceurl,sourcemimetype){var context={};return context.url=mediaurl,context.name=mediafilename,context.issubtitling=STATE.subtitling&&"0"!==STATE.subtitling,context.includesourcetrack=STATE.transcoding&&mediaurl!==sourceurl&&"wav"!==sourceurl.slice(-3)&&!1!==sourceurl,context.CP=CLOUDPOODLL,context.subtitleurl=mediaurl+".vtt",context.sourceurl=sourceurl,context.sourcemimetype=sourcemimetype,{context:context,template:TEMPLATES.HTML_MEDIA.LINK}}insertIntoEditor(template,context){var content=Y.Handlebars.compile(template)(context);this.editor.focus(),this.get("host").insertContentAtFocusPoint(content),this.markUpdated()}createMediaTemplate(context,sourcemimetype,template){return STATE.currentrecorder===RECORDERS.VIDEO||STATE.currentrecorder===RECORDERS.SCREEN?(context.width=!1,context.height=!1,context.poster=!1,STATE.transcoding?context.urlmimetype="video/mp4":context.urlmimetype=sourcemimetype,template=TEMPLATES.HTML_MEDIA.VIDEO):(context.width=!1,context.height=!1,context.poster=!1,STATE.transcoding?context.urlmimetype="audio/mp3":context.urlmimetype=sourcemimetype,template=TEMPLATES.HTML_MEDIA.AUDIO),template}doInsert(mediaurl,mediafilename,sourceurl,sourcemimetype){this.getDialogue({focusAfterHide:null}).hide();var medialink=this._createMediaLink(mediaurl,mediafilename,sourceurl,sourcemimetype),context=medialink.context,template=medialink.template;switch(STATE.insertmethod){case _common.INSERTMETHOD.TAGS:template=this._createMediaTemplate(context,sourcemimetype,template);case _common.INSERTMETHOD.LINK:}require(["core/ajax"],(function(ajax){ajax.call([{methodname:"atto_cloudpoodll_history_create",args:{recordertype:STATE.currentrecorder,mediafilename:mediafilename,sourceurl:sourceurl,mediaurl:mediaurl,sourcemimetype:sourcemimetype,subtitling:STATE.subtitling?1:0,subtitleurl:STATE.subtitling?mediaurl+".vtt":""}}])})),this._insertIntoEditor(template,context)}static fetchRecorderDimensions(config){var sizes={};switch(config.videoskin){case _common.SKIN.ONETWOTHREE:case _common.SKIN.SCREEN:sizes.videowidth=441,sizes.videoheight=540;break;case _common.SKIN.BMR:sizes.videowidth=441,sizes.videoheight=500;break;default:sizes.videowidth=441,sizes.videoheight=450}return config.audioskin,sizes.audiowidth=450,sizes.audioheight=350,sizes}static generateRandomString(){for(var characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",result="",i=0;i<8;i++){var randomIndex=Math.floor(Math.random()*characters.length);result+=characters.charAt(randomIndex)}return result}static getModalClass(){var _class;const modalType="".concat(_common.component,"/rec_audio"),registration=_modal_registry.default.get(modalType);if(registration)return registration.module;const AudioModal=(_defineProperty(_class=class extends _modal.default{},"TYPE",modalType),_defineProperty(_class,"TEMPLATE","".concat(_common.component,"/root")),_class);return _modal_registry.default.register(AudioModal.TYPE,AudioModal,AudioModal.TEMPLATE),AudioModal}static getModalContext(editor){var context={},config=(0,_options.getCloudpoodll)(editor);return _log.default.debug(config),context.CSS=_common.CSS,context.insertmethod=config.insertmethod,context.subtitleaudiobydefault=config.subtitleaudiobydefault,context.subtitlevideobydefault=config.subtitlevideobydefault,context.transcoding="1"==config.cp_transcode,context.filetitledisplaylength=config.filetitle_displaylength,context.showhistory="1"==config.showhistory,context.showupload="1"==config.showupload,context.showoptions="1"==config.showoptions,context.showexpiredays="1"==config.showexpiredays,context.cansubtitle=config.cp_cansubtitle,context.CP={},context.CP.parent=M.cfg.wwwroot,context.CP.appid="tiny_poodll",context.CP.token=config.cp_token,context.CP.region=config.cp_region,context.CP.owner=config.cp_owner,context.CP.expiredays=config.cp_expiredays,context.CP.cansubtitle=config.cp_cansubtitle,context.CP.language=config.cp_language,context.CP.transcode=config.cp_transcode,context.CP.audioskin=config.cp_audioskin,context.CP.videoskin=config.cp_videoskin,context.CP.fallback=config.fallback,context.CP.sizes=this.fetchRecorderDimensions(config),context["expire_"+config.cp_expiredays]=!0,context["lang_"+config.cp_language]=!0,context}static async display(editor){const ModalClass=this.getModalClass(),templatecontext=this.getModalContext(editor),elementid=this.generateRandomString();templatecontext.isaudio=!0,templatecontext.recorder="audio",templatecontext.elementid=elementid;const modal=await ModalFactory.create({type:ModalClass.TYPE,templateContext:templatecontext,large:!0});return new this(editor,elementid,modal,templatecontext).loadRecorders(),modal.show(),modal}},_exports.default}));

//# sourceMappingURL=rec_audio.min.js.map