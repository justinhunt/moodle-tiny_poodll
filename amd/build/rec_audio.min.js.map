{"version":3,"file":"rec_audio.min.js","sources":["../src/rec_audio.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Poodll - audio recorder configuration.\n *\n * @module      tiny_poodll/audio_recorder\n * @copyright   2023 Justin Hunt <justin@poodll.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Pending from 'core/pending';\nimport Log from 'core/log';\nimport {getCloudpoodll} from './options';\nimport uploadFile from 'editor_tiny/uploader';\nimport {add as addToast} from 'core/toast';\nimport * as ModalEvents from 'core/modal_events';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as Templates from 'core/templates';\nimport {saveCancelPromise} from 'core/notification';\nimport {prefetchStrings, prefetchTemplates} from 'core/prefetch';\nimport Modal from \"./modal\";\nimport ModalRegistry from 'core/modal_registry';\n\nimport {\n    component,\n    INSERTMETHOD,\n    LANGUAGE,\n    CSS,\n    SKIN\n} from './common';\n\n/**\n * The Poodll base class for audio, video, and any other future types\n */\nexport default class {\n\n    /**\n     * Constructor for the Tiny Poodll Recorder\n     *\n     * @param {TinyMCE} editor The Editor to which the content will be inserted\n     * @param {elementid} elementid\n     * @param {Modal} modal The Moodle Modal that contains the interface used for recording\n     * @param {config} config The data passed to template and used internally for managing plugin state\n     */\n    constructor(editor,elementid, modal, config) {\n        this.ready = false;\n/*\n        if (!this.checkAndWarnAboutBrowserCompatibility()) {\n            return;\n        }\n*/\n        this.editor = editor;\n        this.elementid = elementid;\n        this.config = config;//getData(editor).params;\n        this.modal = modal;\n        this.modalRoot = modal.getRoot()[0];\n   //     this.startStopButton = this.modalRoot.querySelector('button[data-action=\"startstop\"]');\n   //     this.uploadButton = this.modalRoot.querySelector('button[data-action=\"upload\"]');\n\n        // Disable the record button untilt he stream is acquired.\n    //    this.setRecordButtonState(false);\n\n    //    this.player = this.configurePlayer();\n        this.registerEventListeners();\n        this.ready = true;\n\n      //  this.captureUserMedia();\n      //  this.prefetchContent();\n    }\n\n    /**\n     * Close the modal and stop recording.\n     */\n    close() {\n        // Closing the modal will destroy it and remove it from the DOM.\n        // It will also stop the recording via the hidden Modal Event.\n        this.modal.hide();\n    }\n\n    /**\n     * Register event listeners for the modal.\n     */\n    registerEventListeners() {\n        var that =this;\n        const $root = this.modal.getRoot();\n        const root = $root[0];\n        //get a handle on the controls we need to work with\n        var controls={};\n        const recorders = root.querySelectorAll('.' + CSS.CP_SWAP);\n\n        /*\n        $root.on(ModalEvents.save, (event, modal) => {\n            handleDialogueSubmission(editor, modal, data);\n        });\n        */\n\n        root.addEventListener('click', (e) => {\n           // const cbox = e.target.closest('[type=\"checkbox\"]');\n           // if (cbox) {\n            Log.debug(e.target.id);\n                switch (e.target.id) {\n                    case that.elementid + '_' + CSS.SUBTITLE_CHECKBOX:\n                        //update recorder subtitle setting\n                        if (cbox.get('checked')) {\n                            recorders.forEach((recorder) => {\n                                recorder.setAttribute('data-transcribe', '1');\n                                recorder.setAttribute('data-subtitle', '1');\n                                recorder.setAttribute('data-alreadyparsed', 'false');\n                                recorder.innerHTML = \"\";\n                            });\n                            controls.subtitling = true;\n                        } else {\n                            recorders.forEach((recorder) => {\n                                recorder.setAttribute('data-transcribe', '0');\n                                recorder.setAttribute('data-subtitle', '0');\n                                recorder.setAttribute('data-alreadyparsed', 'false');\n                                recorder.innerHTML = \"\";\n                            });\n                            controls.subtitling = false;\n                        }\n                        //reload the recorders\n                        that.loadRecorders();\n                        break;\n                    case  that.elementid + '_' + CSS.MEDIAINSERT_CHECKBOX:\n                        //update recorder subtitle setting\n                        if (cbox.get('checked')) {\n                            controls.insertmethod = INSERTMETHOD.TAGS;\n                        } else {\n                            controls.insertmethod = INSERTMETHOD.LINK;\n                        }\n                        break;\n                }\n           // }\n        });\n        root.addEventListener('change', (e) => {\n            const dropdown = e.target;\n            if(dropdown){\n                switch(dropdown.id){\n                    case that.elementid + '_' + CSS.LANG_SELECT:\n                        CLOUDPOODLL.language =dropdown.get('value');\n                        recorders.forEach((recorder) => {\n                            recorder.setAttribute('data-language', CLOUDPOODLL.language);\n                            recorder.setAttribute('data-alreadyparsed', 'false');\n                            recorder.innerHTML=\"\";\n                        });\n                        that.loadRecorders();\n                        break;\n                    case that.elementid + '_' + CSS.EXPIREDAYS_SELECT:\n                        //do something\n                        recorders.forEach((recorder) => {\n                            recorder.setAttribute('data-expiredays', CLOUDPOODLL.expiredays);\n                            recorder.setAttribute('data-alreadyparsed', 'false');\n                            recorder.innerHTML=\"\";\n                        });\n                        that.loadRecorders();\n                }\n\n            }\n\n        });\n\n        /*\n        this.modalRoot.addEventListener('click', this.handleModalClick.bind(this));\n        this.modal.getRoot().on(ModalEvents.outsideClick, this.outsideClickHandler.bind(this));\n        this.modal.getRoot().on(ModalEvents.hidden, () => {\n            this.cleanupStream();\n            this.requestRecordingStop();\n        });\n\n         */\n    }\n\n\n    /**\n     * Display the widgets dialog\n     *\n     * @method _displayDialogue\n     * @private\n     */\n    displayWidgetsDialogue(e, clickedicon) {\n        e.preventDefault();\n        var width = 800;\n\n        var dialogue = this.getDialogue({\n            headerContent: M.util.get_string('dialogtitle', COMPONENTNAME),\n            width: width + 'px',\n            focusAfterHide: clickedicon\n        });\n        //dialog doesn't detect changes in width without this\n        //if you reuse the dialog, this seems necessary\n        if (dialogue.width !== width + 'px') {\n            dialogue.set('width', width + 'px');\n        }\n\n\n        //create content container\n        var bodycontent = Y.Node.create('<div></div>');\n\n        //create and append header\n        var template = Y.Handlebars.compile(BUTTONSHEADERTEMPLATE),\n            content = Y.Node.create(template({\n                headertext: M.util.get_string('chooseinsert', COMPONENTNAME)\n            }));\n        bodycontent.append(content);\n\n        //get button nodes\n        var buttons = this._getButtonsForNames(clickedicon);\n\n        Y.Array.each(buttons, function (button) {\n            bodycontent.append(button);\n        }, bodycontent);\n\n        //set to bodycontent\n        dialogue.set('bodyContent', bodycontent);\n        dialogue.show();\n\n        this.markUpdated();\n    }\n\n    getButtonsForNames(clickedicon) {\n        var allcontent = [];\n        Y.Array.each(CLOUDPOODLL.names, function (thename, currentindex) {\n            //loop start\n            var template = Y.Handlebars.compile(BUTTONTEMPLATE),\n                content = Y.Node.create(template({\n                    elementid: this.get('host').get('elementid'),\n                    name: thename,\n                    templateindex: currentindex\n                }));\n            this._form = content;\n            content.one('.' + CSS.NAMEBUTTON + '_' + currentindex).on('click', this._showTemplateForm, this, currentindex);\n            allcontent.push(content);\n            //loop end\n        }, this);\n\n        return allcontent;\n    }\n\n    /**\n     * Return the widget dialogue content for the tool, attaching any required\n     * events.\n     *\n     * @method _getSubmitButtons\n     * @return {Node} The content to place in the dialogue.\n     * @private\n     */\n    getSubmitButtons(templateindex) {\n\n        var template = Y.Handlebars.compile(SUBMITTEMPLATE),\n\n            content = Y.Node.create(template({\n                elementid: this.get('host').get('elementid'),\n                inserttext: M.util.get_string('insert', COMPONENTNAME)\n            }));\n\n        content.one('.' + CSS.INPUTSUBMIT).on('click', this._doWidgetsInsert, this, templateindex);\n        return content;\n    }\n\n    /**\n     * Display the cloud poodll tool.\n     *\n     * @method _displayDialogue\n     * @private\n     */\n    displayDialogue(e, recorder) {\n        e.preventDefault();\n        this._currentrecorder = recorder;\n\n        if (recorder == RECORDERS.WIDGETS) {\n            this._displayWidgetsDialogue(e, recorder);\n            return;\n        }\n\n        STATE.currentrecorder = recorder;\n\n        //get title and sizes\n        switch (recorder) {\n            case RECORDERS.SCREEN:\n                var title = M.util.get_string('createscreen', COMPONENTNAME);\n                var width = '502';\n                var height = \"660\";\n                break;\n\n            case RECORDERS.VIDEO:\n                var title = M.util.get_string('createvideo', COMPONENTNAME);\n                switch (CLOUDPOODLL.videoskin) {\n                    case SKIN.ONETWOTHREE:\n                        var width = '500';\n                        var height = \"660\";\n                        break;\n                    case SKIN.PLAIN:\n                        var width = '500';\n                        var height = \"580\";\n                        break;\n                    case SKIN.BMR:\n                        var width = '500';\n                        var height = \"620\";\n                        break;\n                    default:\n                        var width = '500';\n                        var height = false;\n\n                }\n                break;\n            case RECORDERS.AUDIO:\n            default:\n                var title = M.util.get_string('createaudio', COMPONENTNAME);\n                var width = '501';\n                var height = false;\n                break;\n        }\n\n        //set default subtitling flag\n        if (CLOUDPOODLL.cansubtitle) {\n            if (STATE.currentrecorder == RECORDERS.VIDEO ||\n                STATE.currentrecorder == RECORDERS.SCREEN) {\n                STATE.subtitling = STATE.subtitlevideobydefault;\n            } else {\n                STATE.subtitling = STATE.subtitleaudiobydefault;\n            }\n        }else{\n            STATE.subtitling = 0;\n        }\n\n        var d_conf = {};\n        d_conf.center = true;\n        d_conf.headerContent = title;\n        d_conf.focusAfterHide = recorder;\n        d_conf.width = width + 'px';\n        if (height) {\n            d_conf.height = height + 'px';\n        }\n\n        var dialogue = this.getDialogue(d_conf);\n\n        //if this dialog had a different size and title (it was popped up before as diff media recorder type)\n        if (dialogue.get('width') != width + 'px') {\n            dialogue.set('headerContent', title);\n            //sadly the width and height won't change .. whatever\n            dialogue.set('width', width + 'px');\n            dialogue.set('height', height + 'px');\n        }\n\n        var output = '';\n        if (CLOUDPOODLL.token == '') {\n            output = M.util.get_string('notoken', COMPONENTNAME);\n        } else {\n            //this block should be portioned into an async/await and function, but shifter wont allow it.\n            var context = this._getContext();\n            var that = this;\n            require(['core/templates','core/ajax', 'core/notification'], function (templates,ajax, notification) {\n\n                templates.render('atto_cloudpoodll/root', context).then(function (html, js) {\n                    output = html;\n                    var content = Y.Node.create(output);\n\n                    // Set the dialogue content, and then show the dialogue.\n                    dialogue.set('bodyContent', content).show();\n\n\n                    //store some common elements we will refer to later\n                    STATE.elementid = that.get('host').get('elementid');\n                    STATE.subtitlecheckbox = Y.one('#' + STATE.elementid + '_' + CSS.SUBTITLE_CHECKBOX);\n                    STATE.mediainsertcheckbox = Y.one('#' + STATE.elementid + '_' + CSS.MEDIAINSERT_CHECKBOX);\n                    STATE.languageselect = Y.one('#' + STATE.elementid + '_' + CSS.LANG_SELECT);\n                    STATE.expiredays = Y.one('#' + STATE.elementid + '_' + CSS.EXPIREDAYS_SELECT);\n                    var topnode = Y.one('#' + STATE.elementid + '_' + CSS.ATTO_CLOUDPOODLL_FORM);\n\n\n                    //this is important?\n                    poodllRecorder = that;\n\n                    //subtitle checkbox click event.. reload recorders\n                    if (STATE.subtitlecheckbox != null) {\n                        //if we can subtitle, handle events, otherwise disable it\n                        if (CLOUDPOODLL.cansubtitle) {\n                            STATE.subtitlecheckbox.on('click', function (e) {\n                                var element = e.currentTarget;\n                                //update recorder subtitle setting\n                                if (element.get('checked')) {\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-transcribe', '1');\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-subtitle', '1');\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-alreadyparsed', 'false');\n                                    STATE.subtitling = true;\n                                } else {\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-transcribe', '0');\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-subtitle', '0');\n                                    topnode.all('.' + CSS.CP_SWAP).setAttribute('data-alreadyparsed', 'false');\n                                    STATE.subtitling = false;\n                                }\n                                //reload the recorders\n                                topnode.all('.' + CSS.CP_SWAP).empty();\n                                that._loadRecorders();\n                            });\n                        } else {\n                            this._disableSubtitleCheckbox();\n                        }\n                    }\n\n                    //insert method checkbox;\n                    if (STATE.mediainsertcheckbox != null) {\n                        STATE.mediainsertcheckbox.on('click', function (e) {\n                            var element = e.currentTarget;\n                            //update recorder subtitle setting\n                            if (element.get('checked')) {\n                                STATE.insertmethod = INSERTMETHOD.TAGS;\n                            } else {\n                                STATE.insertmethod = INSERTMETHOD.LINK;\n                            }\n                        });\n                    }\n\n                    //language selector\n                    if (STATE.languageselect != null) {\n                        STATE.languageselect.on('change', function (e) {\n                            var element = e.currentTarget;\n                            if (element) {\n                                CLOUDPOODLL.language =element.get('value');\n                                topnode.all('.' + CSS.CP_SWAP).setAttribute('data-language', CLOUDPOODLL.language);\n                                topnode.all('.' + CSS.CP_SWAP).setAttribute('data-alreadyparsed', 'false');\n                                //reload the recorders\n                                topnode.all('.' + CSS.CP_SWAP).empty();\n                                that._loadRecorders();\n                            }\n                        });\n                    }\n\n                    //expire days selector\n                    if (STATE.expiredays != null) {\n                        STATE.expiredays.on('change', function (e) {\n                            var element = e.currentTarget;\n                            if (element) {\n                                CLOUDPOODLL.expiredays = element.get('value');\n                                topnode.all('.' + CSS.CP_SWAP).setAttribute('data-expiredays', CLOUDPOODLL.expiredays);\n                                topnode.all('.' + CSS.CP_SWAP).setAttribute('data-alreadyparsed', 'false');\n                                //reload the recorders\n                                topnode.all('.' + CSS.CP_SWAP).empty();\n                                that._loadRecorders();\n                            }\n                        });\n                    }\n\n                    //so finally load those recorders\n                    that._loadRecorders();\n\n\n                }).fail(function (ex) {\n                    notification.exception(ex);\n\n                });\n            });\n\n        }//end of if cloudpoodll token\n    }\n\n    disableSubtitleCheckbox() {\n        //this function is never called, because if not transcribable, not shown\n        STATE.subtitlecheckbox.setAttribute('disabled', true);\n        var topnode = Y.one('#' + STATE.elementid + '_' + CSS.ATTO_CLOUDPOODLL_FORM);\n        topnode.all('.' + CSS.CP_SWAP).setAttribute('data-transcribe', '0');\n        topnode.all('.' + CSS.CP_SWAP).setAttribute('data-subtitle', '0');\n    }\n\n    /**\n     * Loads the history tab html.\n     *\n     * @method loadHistory\n     */\n    loadHistory() {\n        require(['core/templates','core/ajax', 'core/notification'], function (templates,ajax, notification) {\n            ajax.call([{\n                methodname: 'atto_cloudpoodll_history_get_items',\n                args: {'recordertype' : STATE.currentrecorder},\n                done: function (historyitems) {\n                    /**\n                     * Takes a mysql unix timestamp (in seconds) and converts to a display date.\n                     *\n                     * @method _formatUnixDate\n                     * @param dateToFormat Date to format\n                     */\n                    function _formatUnixDate(dateToFormat) {\n                        var dateObj = new Date(dateToFormat * 1000);\n\n                        var month = dateObj.getUTCMonth() + 1;\n                        var day = dateObj.getUTCDate();\n                        var year = dateObj.getUTCFullYear();\n\n                        return month + \"/\" + day + \"/\" + year;\n                    }\n\n                    if (Array.isArray(historyitems.responses)) {\n                        historyitems.responses.forEach(function(item){\n                            item.displaydateofentry = _formatUnixDate(item.dateofentry);\n                            item.displayfiletitle = item.filetitle.substring(0, STATE.filetitledisplaylength) + '...';\n                        });\n                        historyitems.responses.formatted = JSON.stringify(historyitems.responses);\n                    }\n\n                    var context = {data: historyitems.responses};\n\n                    templates.render('atto_cloudpoodll/historypanel', context)\n                        .then(function (html, js) {\n                            templates.replaceNodeContents('div[data-field=\"history\"]', html, js);\n                        }).fail(function (ex) {\n                        notification.exception(ex);\n                    });\n                }\n            }]);\n        });\n    }\n\n    /**\n     * Loads the history video preview tab html.\n     *\n     * @method loadHistoryPreview\n     * @param historyItem History item ID from list.\n     */\n    loadHistoryPreview(historyItem) {\n        require(['core/templates', 'core/ajax', 'core/notification'], function (templates, ajax, notification) {\n            ajax.call([{\n                methodname: 'atto_cloudpoodll_history_get_item',\n                args: {'id': historyItem.dataset.historyId},\n                done: function (historyItemData) {\n                    var context = {\n                        data: historyItemData.responses,\n                        isVideo: STATE.currentrecorder === RECORDERS.VIDEO || STATE.currentrecorder === RECORDERS.SCREEN\n                    };\n                    templates.render('atto_cloudpoodll/historypreview', context)\n                        .then(function (html, js) {\n                            templates.replaceNodeContents('div[data-field=\"history\"]', html, js);\n                        }).fail(function (ex) {\n                        notification.exception(ex);\n                    });\n                }\n            }]);\n        });\n    }\n\n    /**\n     * Loads or reloads the recorders\n     *\n     * @method _loadRecorders\n     * @private\n     */\n    loadRecorders() {\n        var that = this;\nLog.debug('loading recorders');\n        that.uploaded = false;\n        that.ap_count = 0;\n        require(['tiny_poodll/cloudpoodllloader'], function (loader) {\n            var recorder_callback = function (evt) {\n                switch (evt.type) {\n                    case 'recording':\n                        if (evt.action === 'started') {\n                            //if user toggled subtitle checkbox any time from now, the recording would be lost\n                            if (STATE.subtitlecheckbox != null) {\n                                STATE.subtitlecheckbox.set('disabled', true);\n                            }\n\n                        }\n                        break;\n                    case 'awaitingprocessing':\n                        //we delay  a second to allow the sourcefile to be copied to correct location\n                        //the source filename will sometimes be incorrect because we do not know it when creating the dynamo db entry\n                        // but an incorrect ext is just confusing. most players will ignore it and deal with contents\n                        if (!that.uploaded) {\n                            setTimeout(function () {\n                                var guessed_ext = loader.fetch_guessed_extension(STATE.currentrecorder );\n                                var sourcefilename = evt.sourcefilename.split('.').slice(0, -1).join('.') + '.' + guessed_ext;\n                                var sourceurl = evt.s3root + sourcefilename;\n                                that._doInsert(evt.mediaurl, evt.mediafilename, sourceurl, evt.sourcemimetype);\n                            }, 4000);\n                            that.uploaded = true;\n                        }\n                        break;\n                    case 'filesubmitted':\n                        //we will probably never get here because awaiting processing will fire first\n                        //we do not use this event, but it arrives when the final file is ready. (much earlier in case of non-transcode)\n\n                        break;\n                    case 'error':\n                        alert('PROBLEM:' + evt.message);\n                        break;\n                }\n            };\n            loader.init(CSS.CP_SWAP, recorder_callback);\n        });\n    }\n\n    /**\n     * Inserts the history item info the page.\n     *\n     * @method insertHistoryItem\n     * @param  historyItem object\n     * @private\n     */\n    insertHistoryItem(historyItem) {\n        poodllRecorder.getDialogue({\n            focusAfterHide: null\n        }).hide();\n\n        require(['core/ajax'], function (ajax) {\n            ajax.call([{\n                methodname: 'atto_cloudpoodll_history_get_item',\n                args: {'id': historyItem.dataset.historyId},\n                done: function (historyItemData) {\n                    //const [first] = historyItemData.responses;\n                    //var item = first;\n                    var item = historyItemData.responses[0];\n                    var mediaLink = poodllRecorder._createMediaLink(\n                        item.mediaurl,\n                        item.mediafilename,\n                        item.sourceurl,\n                        item.sourcemimetype\n                    );\n\n                    switch (STATE.insertmethod) {\n\n                        case INSERTMETHOD.TAGS:\n                            mediaLink.template = poodllRecorder._createMediaTemplate(mediaLink.context, item.sourcemimetype, mediaLink.template);\n                            break;\n\n                        case INSERTMETHOD.LINK:\n                        default:\n                        //do nothing we already made the template as a link\n                    }\n\n                    poodllRecorder._insertIntoEditor(mediaLink.template, mediaLink.context);\n                }\n            }]);\n        });\n    }\n\n    /**\n     * Creates the media link based on the recorder type.\n     *\n     * @method _createMediaLink\n     * @param  mediaurl media URL to the AWS object\n     * @param  mediafilename File name of the AWS object\n     * @param  sourceurl URL to the AWS object\n     * @param  sourcemimetype MimeType of the AWS object\n     * @private\n     */\n    createMediaLink(mediaurl, mediafilename, sourceurl, sourcemimetype) {\n        var context = {};\n        context.url = mediaurl;\n        context.name = mediafilename;\n        context.issubtitling = STATE.subtitling && STATE.subtitling !== '0';\n        context.includesourcetrack = STATE.transcoding && (mediaurl !== sourceurl) && (sourceurl.slice(-3) !== 'wav') && (sourceurl !== false);\n        context.CP = CLOUDPOODLL;\n        context.subtitleurl = mediaurl + '.vtt';\n        context.sourceurl = sourceurl;\n        context.sourcemimetype = sourcemimetype;\n\n        var template = TEMPLATES.HTML_MEDIA.LINK;\n\n        return {context: context, template: template};\n    }\n\n    /**\n     * Inserts the item into the editor.\n     *\n     * @method _createMediaLink\n     * @param  template HTML template to insert into the editor\n     * @param  context Context of the item being inserted\n     * @private\n     */\n    insertIntoEditor(template, context) {\n        var content =\n            Y.Handlebars.compile(template)(context);\n        this.editor.focus();\n        this.get('host').insertContentAtFocusPoint(content);\n        this.markUpdated();\n    }\n\n    /**\n     * Creates the media template for audio/video.\n     *\n     * @method _createMediaTemplate\n     * @param  context Context of the item being inserted\n     * @param  sourcemimetype MimeType of the AWS object\n     * @param  context Context of the item being inserted\n     * @private\n     */\n    createMediaTemplate(context, sourcemimetype, template) {\n        if (STATE.currentrecorder === RECORDERS.VIDEO || STATE.currentrecorder === RECORDERS.SCREEN) {\n            context.width = false;\n            context.height = false;\n            context.poster = false;\n            if (STATE.transcoding) {\n                context.urlmimetype = 'video/mp4';\n            } else {\n                context.urlmimetype = sourcemimetype;\n            }\n            template = TEMPLATES.HTML_MEDIA.VIDEO;\n        } else {\n            context.width = false;\n            context.height = false;\n            context.poster = false;\n            if (STATE.transcoding) {\n                context.urlmimetype = 'audio/mp3';\n            } else {\n                context.urlmimetype = sourcemimetype;\n            }\n            template = TEMPLATES.HTML_MEDIA.AUDIO;\n        }\n        return template;\n    }\n\n    /**\n     * Inserts the link or media element onto the page\n     * @method _doInsert\n     * @private\n     */\n    doInsert(mediaurl, mediafilename, sourceurl, sourcemimetype) {\n        this.getDialogue({\n            focusAfterHide: null\n        }).hide();\n\n        //default context values(link) for template\n        // var {context, template}\n        var medialink = this._createMediaLink(mediaurl, mediafilename, sourceurl, sourcemimetype);\n        var context = medialink.context;\n        var template = medialink.template;\n        function saveToHistory() {\n            require(['core/ajax'], function (ajax) {\n                ajax.call([{\n                    methodname: 'atto_cloudpoodll_history_create',\n                    args: {\n                        recordertype: STATE.currentrecorder,\n                        mediafilename: mediafilename,\n                        sourceurl: sourceurl,\n                        mediaurl: mediaurl,\n                        sourcemimetype: sourcemimetype,\n                        subtitling: STATE.subtitling ? 1 : 0,\n                        subtitleurl: STATE.subtitling ? mediaurl + '.vtt' : '',\n                    },\n                }]);\n            });\n        }\n\n        switch (STATE.insertmethod) {\n\n            case INSERTMETHOD.TAGS:\n                template = this._createMediaTemplate(context, sourcemimetype, template);\n                break;\n\n            case INSERTMETHOD.LINK:\n                break;\n            default:\n            //do nothing special actually.\n        }\n        saveToHistory();\n        this._insertIntoEditor(template, context);\n    } //end of doinsert\n\n    static fetchRecorderDimensions(config) {\n\n        // Get return object\n        var sizes = {};\n\n        //get video sizes]\n        switch (config.videoskin) {\n            case SKIN.ONETWOTHREE:\n            case SKIN.SCREEN:\n                sizes.videowidth = 441; //(because the @media CSS is for <=440)\n                sizes.videoheight = 540;\n                break;\n            case SKIN.BMR:\n                sizes.videowidth = 441; //(because the @media CSS is for <=440)\n                sizes.videoheight = 500;\n                break;\n            default:\n                sizes.videowidth = 441;\n                sizes.videoheight = 450;\n\n        }\n        switch (config.audioskin) {\n            default:\n                sizes.audiowidth = 450;\n                sizes.audioheight = 350;\n                break;\n        }\n        return sizes;\n    }\n\n    static generateRandomString() {\n        var length = 8;\n        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n        var result = '';\n\n        for (var i = 0; i < length; i++) {\n            var randomIndex = Math.floor(Math.random() * characters.length);\n            result += characters.charAt(randomIndex);\n        }\n\n        return result;\n    }\n\n\n    static getModalClass() {\n        const modalType = `${component}/rec_audio`;\n        const registration = ModalRegistry.get(modalType);\n        if (registration) {\n            return registration.module;\n        }\n\n        const AudioModal = class extends Modal {\n            static TYPE = modalType;\n            static TEMPLATE = `${component}/root`;\n        };\n\n        ModalRegistry.register(AudioModal.TYPE, AudioModal, AudioModal.TEMPLATE);\n        return AudioModal;\n    }\n\n    static getModalContext(editor) {\n\n        var context = {};\n        var config = getCloudpoodll(editor);\n        Log.debug(config);\n        \n        //stuff declared in common\n        context.CSS = CSS;\n\n        //insert method\n        context.insertmethod = config.insertmethod;\n\n        //subtitle by default\n        context.subtitleaudiobydefault = config.subtitleaudiobydefault;\n        context.subtitlevideobydefault = config.subtitlevideobydefault;\n\n        //transcoding flag\n        context.transcoding = config.cp_transcode == '1';\n\n        //file title display length\n        context.filetitledisplaylength = config.filetitle_displaylength;\n\n        //show tabs\n        context.showhistory = config.showhistory== '1';\n        context.showupload = config.showupload== '1';\n        context.showoptions = config.showoptions== '1';\n        context.showexpiredays = config.showexpiredays== '1';\n        context.cansubtitle = config.cp_cansubtitle;\n\n        //set up the cloudpoodll div\n        context.CP={};\n        context.CP.parent = M.cfg.wwwroot;\n        context.CP.appid = 'tiny_poodll';\n        context.CP.token = config.cp_token;\n        context.CP.region = config.cp_region;\n        context.CP.owner = config.cp_owner;\n        context.CP.expiredays = config.cp_expiredays;\n        context.CP.cansubtitle = config.cp_cansubtitle;\n        context.CP.language = config.cp_language;\n        context.CP.transcode = config.cp_transcode;\n        context.CP.audioskin = config.cp_audioskin;\n        context.CP.videoskin = config.cp_videoskin;\n        context.CP.fallback = config.fallback;\n        context.CP.sizes = this.fetchRecorderDimensions(config);\n\n        //get defaults for expire days and subtitle language\n        context['expire_' + config.cp_expiredays] =true;\n        context['lang_' + config.cp_language] =true;\n\n        return context;\n    }\n\n    static async display(editor) {\n        const ModalClass = this.getModalClass();\n        const templatecontext = this.getModalContext(editor);\n        const elementid = this.generateRandomString();\n\n        //TO DO set these settigns according to the toolbar button which was clicked\n        templatecontext.isaudio=true;\n        templatecontext.recorder = 'audio'; //(audio or video)\n        templatecontext.elementid = elementid;\n\n        const modal = await ModalFactory.create({\n            type: ModalClass.TYPE,\n            templateContext: templatecontext,\n            large: true,\n        });\n\n        // Set up the Recorder.\n        const recorder = new this(editor, elementid, modal, templatecontext);\n        recorder.loadRecorders();\n       // if (recorder.isReady()) {\n            modal.show();\n        //}\n        return modal;\n    }\n\n} //end of class\n"],"names":["constructor","editor","elementid","modal","config","ready","modalRoot","getRoot","registerEventListeners","close","hide","that","this","root","controls","recorders","querySelectorAll","CSS","CP_SWAP","addEventListener","e","debug","target","id","SUBTITLE_CHECKBOX","cbox","get","forEach","recorder","setAttribute","innerHTML","subtitling","loadRecorders","MEDIAINSERT_CHECKBOX","insertmethod","INSERTMETHOD","TAGS","LINK","dropdown","LANG_SELECT","CLOUDPOODLL","language","EXPIREDAYS_SELECT","expiredays","displayWidgetsDialogue","clickedicon","preventDefault","dialogue","getDialogue","headerContent","M","util","get_string","COMPONENTNAME","width","focusAfterHide","set","bodycontent","Y","Node","create","template","Handlebars","compile","BUTTONSHEADERTEMPLATE","content","headertext","append","buttons","_getButtonsForNames","Array","each","button","show","markUpdated","getButtonsForNames","allcontent","names","thename","currentindex","BUTTONTEMPLATE","name","templateindex","_form","one","NAMEBUTTON","on","_showTemplateForm","push","getSubmitButtons","SUBMITTEMPLATE","inserttext","INPUTSUBMIT","_doWidgetsInsert","displayDialogue","_currentrecorder","RECORDERS","WIDGETS","STATE","currentrecorder","SCREEN","title","height","VIDEO","videoskin","SKIN","ONETWOTHREE","PLAIN","BMR","AUDIO","cansubtitle","subtitlevideobydefault","subtitleaudiobydefault","d_conf","output","token","context","_getContext","require","templates","ajax","notification","render","then","html","js","subtitlecheckbox","mediainsertcheckbox","languageselect","topnode","ATTO_CLOUDPOODLL_FORM","poodllRecorder","currentTarget","all","empty","_loadRecorders","_disableSubtitleCheckbox","element","fail","ex","exception","_displayWidgetsDialogue","disableSubtitleCheckbox","loadHistory","call","methodname","args","done","historyitems","isArray","responses","item","dateToFormat","dateObj","displaydateofentry","dateofentry","Date","getUTCMonth","getUTCDate","getUTCFullYear","displayfiletitle","filetitle","substring","filetitledisplaylength","formatted","JSON","stringify","data","replaceNodeContents","loadHistoryPreview","historyItem","dataset","historyId","historyItemData","isVideo","uploaded","ap_count","loader","init","evt","type","action","setTimeout","guessed_ext","fetch_guessed_extension","sourcefilename","split","slice","join","sourceurl","s3root","_doInsert","mediaurl","mediafilename","sourcemimetype","alert","message","insertHistoryItem","mediaLink","_createMediaLink","_createMediaTemplate","_insertIntoEditor","createMediaLink","url","issubtitling","includesourcetrack","transcoding","CP","subtitleurl","TEMPLATES","HTML_MEDIA","insertIntoEditor","focus","insertContentAtFocusPoint","createMediaTemplate","poster","urlmimetype","doInsert","medialink","recordertype","sizes","videowidth","videoheight","audioskin","audiowidth","audioheight","characters","result","i","randomIndex","Math","floor","random","length","charAt","modalType","component","registration","ModalRegistry","module","AudioModal","Modal","register","TYPE","TEMPLATE","cp_transcode","filetitle_displaylength","showhistory","showupload","showoptions","showexpiredays","cp_cansubtitle","parent","cfg","wwwroot","appid","cp_token","region","cp_region","owner","cp_owner","cp_expiredays","cp_language","transcode","cp_audioskin","cp_videoskin","fallback","fetchRecorderDimensions","ModalClass","getModalClass","templatecontext","getModalContext","generateRandomString","isaudio","ModalFactory","templateContext","large"],"mappings":"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"}